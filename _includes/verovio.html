


<script src="resources/js/verovio-toolkit.js" type="text/javascript" charset="utf-8"></script>

<script>
// vim: ts=3

// set up Verovio
var vrvToolkit = new verovio.toolkit();                            



	
// function called to show the right code
var showCode = function(which, id) {
	if (which === 'excerpt') {
		document.querySelector('#' + id + '_excerpt_link').classList.add('active');
		document.querySelector('#' + id + '_full_link').classList.remove('active');
		document.querySelector('#' + id + '_excerpt_container').classList.remove('hide');
		document.querySelector('#' + id + '_full_container').classList.add('hide');
	} else {
		document.querySelector('#' + id + '_excerpt_link').classList.remove('active');
		document.querySelector('#' + id + '_full_link').classList.add('active');
		document.querySelector('#' + id + '_excerpt_container').classList.add('hide');
		document.querySelector('#' + id + '_full_container').classList.remove('hide');
	}
};
	
var loadMEI = function(id, uri, selector, options) {
	vrvToolkit.setOptions(options);

	$.get('./samples/' + uri, function (fullMei) {


		var fullEditor = ace.edit(document.querySelector('#' + id + '_full'));
		fullEditor.$blockScrolling = Infinity;
		// fullEditor.setTheme("ace/theme/textmate");
		fullEditor.setTheme("ace/theme/eclipse");
		fullEditor.getSession().setMode("ace/mode/xml");
		fullEditor.setReadOnly(true);
		fullEditor.setShowPrintMargin(false);
		fullEditor.session.setValue(fullMei);

		// Render and display the image:
		var svg = vrvToolkit.renderData(fullMei + '\n ', {});
		var svgtarget = document.querySelector("#" + id + '_verovio');
		if (svgtarget) {
			svgtarget.innerHTML = svg;
		} else {
			console.log("Cannot find svg target:", "#" + id + '_verovio');
		}

		// Extract short example
		if (selector) {
			var myextract = extractSelection(fullMei, selector);

			var extractEditor = ace.edit(document.querySelector('#' + id + '_excerpt'));
			extractEditor.$blockScrolling = Infinity;
			// extractEditor.setTheme("ace/theme/textmate");
			extractEditor.setTheme("ace/theme/eclipse");
			extractEditor.getSession().setMode("ace/mode/xml");
			extractEditor.setReadOnly(true);
			extractEditor.setShowPrintMargin(false);
			extractEditor.renderer.setShowGutter(false);
			extractEditor.session.setValue(myextract);

			// var shorttarget = document.querySelector("#" + id + '_excerpt .pre');
			// if (shorttarget) {
			// 	shorttarget.textContent = myextract;
			// } else {
			// 	console.log("Cannot find svg target:", "#" + id + '_excerpt .pre');
			// }
		} else {
			document.getElementById(id + '_excerpt_container').classList.remove('hide');
		}

	}, 'text');
};


function extractSelection(xmlstring, selector) {
	var parser = new DOMParser();
	var mydoc = parser.parseFromString(xmlstring, "application/xml");
	var myextracts = mydoc.querySelectorAll(selector);
	var serializer = new XMLSerializer();
	var output = "";
	for (var i=0; i<myextracts.length; i++) {
		myextracts[i].setAttribute("xmlns", "");
		output += serializer.serializeToString(myextracts[i]).replace('xmlns=""', "");
		output += "\n";
	}


	return output.replace(/\s+$/, "");
}


</script>



